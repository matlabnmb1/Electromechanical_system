{% extends "base.html" %}

{% block title %}ç”¨æˆ·ç®¡ç†{% endblock %}

{% block content %}
<div class="bg-white p-6 rounded-lg shadow-md max-w-7xl mx-auto">
    <!-- é¡µé¢æ ‡é¢˜å’Œç»Ÿè®¡ä¿¡æ¯ -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-2xl font-bold text-gray-900">ç”¨æˆ·ç®¡ç†</h2>
            <p class="text-gray-600 mt-1">ç®¡ç†ç³»ç»Ÿä¸­çš„æ‰€æœ‰ç”¨æˆ·è´¦æˆ·å’Œæƒé™</p>
        </div>
        <div class="flex space-x-3">
            <a href="{{ url_for('home') }}" class="bg-gray-600 text-white px-4 py-2 rounded-md hover:bg-gray-700 transition-colors">
                <i class="fas fa-arrow-left mr-2"></i>è¿”å›é¦–é¡µ
            </a>
        </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <!-- ç»Ÿè®¡å¡ç‰‡ä¿æŒä¸å˜ -->
    </div>

    <!-- æœç´¢å’Œè¿‡æ»¤ -->
    <div class="mb-6 p-4 bg-gray-50 rounded-lg">
        <!-- æœç´¢å’Œè¿‡æ»¤ä¿æŒä¸å˜ -->
    </div>
    
    <!-- ç”¨æˆ·åˆ—è¡¨è¡¨æ ¼ -->
    <div class="overflow-x-auto bg-white rounded-lg border border-gray-200">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ç”¨æˆ·ä¿¡æ¯
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        å·¥å·
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ID
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        æ‰‹æœºå·
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        è§’è‰²
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        åŒºé˜Ÿ
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        æ³¨å†Œæ—¶é—´
                    </th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for user in users %}
                <tr class="hover:bg-gray-50 transition-colors user-row" 
                    data-name="{{ user.name|lower if user.name else '' }}" 
                    data-employee-id="{{ user.employee_id|lower if user.employee_id else '' }}" 
                    data-phone="{{ user.phone if user.phone else '' }}" 
                    data-role="{{ user.role if user.role else 'user' }}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">{{ user.name }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900 font-mono">{{ user.employee_id }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-500">{{ user.id }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">{{ user.phone }}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if session.role == 'super_admin' and user.role != 'super_admin' %}
                        <!-- è§’è‰²ä¿®æ”¹è¡¨å• - åœ¨åŸä½ç½® -->
                        <form method="POST" action="{{ url_for('change_user_role', user_id=user.id) }}" 
                              onsubmit="return confirmRoleChange('{{ user.name }}', '{{ 'è¶…çº§ç®¡ç†å‘˜' if user.role == 'super_admin' else 'ç³»ç»Ÿç®¡ç†å‘˜' if user.role == 'admin' else 'æ™®é€šç”¨æˆ·' }}')">
                            <div class="flex items-center space-x-2">
                                <select name="role" class="px-3 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="user" {% if user.role == 'user' %}selected{% endif %}>æ™®é€šç”¨æˆ·</option>
                                    <option value="admin" {% if user.role == 'admin' %}selected{% endif %}>ç³»ç»Ÿç®¡ç†å‘˜</option>
                                </select>
                                <button type="submit" class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700 transition-colors focus:ring-2 focus:ring-purple-500 focus:ring-offset-2">
                                    <i class="fas fa-save mr-1"></i>æ›´æ–°
                                </button>
                            </div>
                        </form>
                        {% else %}
                        <!-- æ˜¾ç¤ºè§’è‰²æ ‡ç­¾ -->
                        <span class="inline-flex px-3 py-1 text-xs font-semibold rounded-full 
                            {% if user.role == 'super_admin' %}bg-red-100 text-red-800 border border-red-200
                            {% elif user.role == 'admin' %}bg-purple-100 text-purple-800 border border-purple-200
                            {% else %}bg-green-100 text-green-800 border border-green-200{% endif %}">
                            <i class="fas {% if user.role == 'super_admin' %}fa-crown{% elif user.role == 'admin' %}fa-user-shield{% else %}fa-user{% endif %} mr-1"></i>
                            {% if user.role == 'super_admin' %}è¶…çº§ç®¡ç†å‘˜
                            {% elif user.role == 'admin' %}ç³»ç»Ÿç®¡ç†å‘˜
                            {% else %}æ™®é€šç”¨æˆ·{% endif %}
                        </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if session.role == 'super_admin' and user.role != 'super_admin' %}
                        <!-- åŒºé˜Ÿä¿®æ”¹è¡¨å• - åœ¨åŸä½ç½® -->
                        <form method="POST" action="{{ url_for('change_user_team', user_id=user.id) }}">
                            <div class="flex items-center space-x-2">
                                <select name="team" class="px-3 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">--é€‰æ‹©åŒºé˜Ÿ--</option>
                                    <option value="æœºç”µä¸€é˜Ÿ" {% if user.team=='æœºç”µä¸€é˜Ÿ' %}selected{% endif %}>æœºç”µä¸€é˜Ÿ</option>
                                    <option value="æœºç”µäºŒé˜Ÿ" {% if user.team=='æœºç”µäºŒé˜Ÿ' %}selected{% endif %}>æœºç”µäºŒé˜Ÿ</option>
                                    <option value="ç»¼é‡‡é˜Ÿ" {% if user.team=='ç»¼é‡‡é˜Ÿ' %}selected{% endif %}>ç»¼é‡‡é˜Ÿ</option>
                                    <option value="è¿è½¬é˜Ÿ" {% if user.team=='è¿è½¬é˜Ÿ' %}selected{% endif %}>è¿è½¬é˜Ÿ</option>
                                </select>
                                <button type="submit" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700 transition-colors focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                                    <i class="fas fa-save mr-1"></i>æ›´æ–°
                                </button>
                            </div>
                        </form>
                        {% else %}
                        <!-- æ˜¾ç¤ºåŒºé˜Ÿæ–‡æœ¬ -->
                        <div class="text-sm text-gray-900">{{ user.team or 'æœªè®¾ç½®' }}</div>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">
                            {{ user.created_at.strftime('%Y-%m-%d %H:%M') if user.created_at else 'æœªçŸ¥' }}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- æƒé™è¯´æ˜ -->
    <div class="mt-6 p-4 bg-purple-50 border border-purple-200 rounded-lg">
        <h3 class="text-sm font-medium text-purple-800 mb-2">ğŸ” æƒé™è¯´æ˜</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-purple-700">
            <div>
                <h4 class="font-medium mb-1">å½“å‰ç”¨æˆ·æƒé™</h4>
                <ul class="list-disc list-inside space-y-1">
                    {% if session.role == 'super_admin' %}
                        <li><strong>è¶…çº§ç®¡ç†å‘˜</strong>ï¼šå¯ä»¥ä¿®æ”¹æ‰€æœ‰ç”¨æˆ·è§’è‰²å’ŒåŒºé˜Ÿ</li>
                        <li><strong>æœ€é«˜æƒé™</strong>ï¼šåŒ…æ‹¬å…¶ä»–ç®¡ç†å‘˜</li>
                    {% elif session.role == 'admin' %}
                        <li><strong>ç³»ç»Ÿç®¡ç†å‘˜</strong>ï¼šåªèƒ½æŸ¥çœ‹ç”¨æˆ·ä¿¡æ¯</li>
                        <li><strong>é™åˆ¶æƒé™</strong>ï¼šä¸èƒ½ä¿®æ”¹ä»»ä½•ç”¨æˆ·ä¿¡æ¯</li>
                    {% else %}
                        <li><strong>æ™®é€šç”¨æˆ·</strong>ï¼šæ— æ³•è®¿é—®æ­¤åŠŸèƒ½</li>
                    {% endif %}
                </ul>
            </div>
            <div>
                <h4 class="font-medium mb-1">æ“ä½œé™åˆ¶</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li>ç”¨æˆ·ä¸èƒ½ä¿®æ”¹è‡ªå·±çš„è§’è‰²</li>
                    <li>åªæœ‰è¶…çº§ç®¡ç†å‘˜å¯ä¿®æ”¹ä»»ä½•ç”¨æˆ·è§’è‰²å’ŒåŒºé˜Ÿ</li>
                    <li>ç³»ç»Ÿåªèƒ½æœ‰ä¸€ä¸ªè¶…çº§ç®¡ç†å‘˜</li>
                    <li>è§’è‰²ä¿®æ”¹ä¼šç«‹å³ç”Ÿæ•ˆ</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- è¯´æ˜å’Œæ³¨æ„äº‹é¡¹ -->
    <div class="mt-4 p-4 bg-blue-50 border border-blue-200 rounded-lg">
        <h3 class="text-sm font-medium text-blue-800 mb-2">ğŸ“‹ æ“ä½œè¯´æ˜</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-700">
            <div>
                <h4 class="font-medium mb-1">åŠŸèƒ½è¯´æ˜</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li><strong>ç®¡ç†å‘˜</strong>ï¼šå¯ä»¥è®¿é—®æ‰€æœ‰ç³»ç»ŸåŠŸèƒ½</li>
                    <li><strong>æ™®é€šç”¨æˆ·</strong>ï¼šåªèƒ½è®¿é—®åŸºæœ¬åŠŸèƒ½</li>
                    <li><strong>åŒºé˜Ÿç®¡ç†</strong>ï¼šè¶…çº§ç®¡ç†å‘˜å¯ä»¥ä¿®æ”¹ç”¨æˆ·åŒºé˜Ÿ</li>
                </ul>
            </div>
            <div>
                <h4 class="font-medium mb-1">æ³¨æ„äº‹é¡¹</h4>
                <ul class="list-disc list-inside space-y-1">
                    <li>ç³»ç»Ÿåªèƒ½æœ‰ä¸€ä¸ªè¶…çº§ç®¡ç†å‘˜</li>
                    <li>å»ºè®®è‡³å°‘ä¿ç•™ä¸€ä¸ªç®¡ç†å‘˜è´¦æˆ·</li>
                    <li>ç”¨æˆ·è§’è‰²å˜æ›´ä¼šè®°å½•åœ¨ç³»ç»Ÿæ—¥å¿—ä¸­</li>
                    <li>è¯·è°¨æ…æ“ä½œï¼Œé¿å…è¯¯æ“ä½œ</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript åŠŸèƒ½ -->
<script>
// æœç´¢å’Œè¿‡æ»¤åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search');
    const roleFilter = document.getElementById('role-filter');
    const userRows = document.querySelectorAll('.user-row');
    
    function filterUsers() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedRole = roleFilter.value;
        
        userRows.forEach(row => {
            const name = row.dataset.name;
            const employeeId = row.dataset.employeeId;
            const phone = row.dataset.phone;
            const role = row.dataset.role;
            
            const matchesSearch = name.includes(searchTerm) || 
                                employeeId.includes(searchTerm) || 
                                phone.includes(searchTerm);
            const matchesRole = !selectedRole || role === selectedRole;
            
            if (matchesSearch && matchesRole) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }
    
    searchInput.addEventListener('input', filterUsers);
    roleFilter.addEventListener('change', filterUsers);
});

// è§’è‰²å˜æ›´ç¡®è®¤
function confirmRoleChange(userName, currentRole) {
    const newRole = event.target.closest('form').querySelector('select[name="role"]').value;
    const newRoleText = newRole === 'admin' ? 'ç³»ç»Ÿç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';
    
    if (currentRole === newRoleText) {
        alert('ç”¨æˆ·è§’è‰²æ²¡æœ‰å‘ç”Ÿå˜åŒ–');
        return false;
    }
    
    const message = 'ç¡®å®šè¦å°†ç”¨æˆ· "' + userName + '" çš„è§’è‰²ä» ' + currentRole + ' æ›´æ”¹ä¸º ' + newRoleText + ' å—ï¼Ÿ\n\næ­¤æ“ä½œå°†ç«‹å³ç”Ÿæ•ˆï¼';
    return confirm(message);
}
</script>
{% endblock %}